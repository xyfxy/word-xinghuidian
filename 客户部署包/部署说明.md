# Word新汇点 - 客户部署包

## 🚀 快速部署指南

这个部署包包含了运行 Word新汇点 所需的所有文件，无需下载完整源代码。

### 📋 部署包内容

```
客户部署包/
├── docker-compose.yml    # Docker 编排文件
├── .env.example         # 环境变量模板
├── update.sh           # 更新脚本
└── 部署说明.md          # 本文档
```

### 🛠️ 系统要求

- Docker 20.10+
- Docker Compose 2.0+
- 至少 1GB 可用内存
- 至少 2GB 可用磁盘空间

### 📦 首次部署步骤

1. **下载部署包**

   ```bash
   # 创建项目目录
   mkdir word-xinghuidian
   cd word-xinghuidian

   # 将部署包文件复制到此目录
   ```
2. **配置环境变量**

   ```bash
   # 复制并编辑环境变量
   cp .env.example .env
   nano .env
   ```

   **必须配置的参数：**

   ```env
   # 项目名称（Docker Compose使用）
   COMPOSE_PROJECT_NAME=word-xinghuidian
   
   # 模型加密密钥（重要！请保持一致，否则无法解密已保存的模型）
   MODEL_ENCRYPTION_KEY=666888  # 默认值，建议修改为自己的密钥
   
   # 版本配置
   VERSION=latest  # 或指定版本如 v1.4.0
   ```
   
   **可选配置（钉钉集成）：**
   
   ```env
   # ========== 钉钉认证配置 ==========
   # 是否启用钉钉认证（限制只能从钉钉访问）
   VITE_ENABLE_DINGTALK_AUTH=false  # 设置为true启用
   ENABLE_DINGTALK_AUTH=false        # 后端也需要同步设置
   
   # 钉钉企业应用配置（启用认证时必填）
   DINGTALK_CORP_ID=your_corp_id
   DINGTALK_AGENT_ID=your_agent_id  
   DINGTALK_APP_KEY=your_app_key
   DINGTALK_APP_SECRET=your_app_secret
   DINGTALK_VERIFY_USER=false  # 是否验证用户身份
   ```
   
   **⚠️ 重要提示：**
   - `MODEL_ENCRYPTION_KEY` 一旦设置后不要修改，否则已保存的AI模型配置将无法解密
   - 如果迁移服务器，必须使用相同的加密密钥
   - **钉钉认证切换**：修改`VITE_ENABLE_DINGTALK_AUTH`和`ENABLE_DINGTALK_AUTH`后，只需重启容器即可生效，无需重新构建镜像
3. **创建数据目录**

   ```bash
   mkdir -p backend/data backend/uploads
   ```
4. **启动服务**

   ```bash
   # 给脚本添加执行权限
   chmod +x update.sh

   # 拉取镜像并启动
   docker-compose pull
   docker-compose up -d
   ```
5. **验证部署**

   ```bash
   # 检查服务状态
   docker-compose ps

   # 检查健康状态
   curl http://localhost:3003/api/health
   ```
6. **访问应用**

   - 在浏览器打开：http://你的服务器IP:3000

### 🔄 更新应用

当有新版本发布时：

```bash
# 更新到最新版本
./update.sh

# 或更新到指定版本
./update.sh v1.4.0
```

### 🔐 钉钉认证配置

**启用钉钉认证（限制只能从钉钉访问）：**

1. 编辑 `.env` 文件：
   ```bash
   nano .env
   ```

2. 修改或添加以下配置：
   ```env
   # 启用钉钉认证
   VITE_ENABLE_DINGTALK_AUTH=true
   ENABLE_DINGTALK_AUTH=true
   
   # 配置钉钉应用信息
   DINGTALK_CORP_ID=你的企业ID
   DINGTALK_AGENT_ID=你的应用ID
   DINGTALK_APP_KEY=你的AppKey
   DINGTALK_APP_SECRET=你的AppSecret
   ```

3. 重新创建容器使配置生效：
   ```bash
   docker-compose up -d
   # 注意：不要使用 docker-compose restart，它不会重新读取环境变量
   ```

**关闭钉钉认证（允许任何人访问）：**

1. 编辑 `.env` 文件，将认证设置为false：
   ```env
   VITE_ENABLE_DINGTALK_AUTH=false
   ENABLE_DINGTALK_AUTH=false
   ```

2. 重新创建容器：
   ```bash
   docker-compose up -d
   ```

**⚠️ 重要提示：** 
- 修改环境变量后必须使用 `docker-compose up -d` 重新创建容器
- 不要使用 `docker-compose restart`，它不会重新读取环境变量
- 无需重新构建或拉取镜像

**⚠️ 重要说明：**
- 更新过程会自动备份现有数据到 `backup-日期时间` 目录
- **不会覆盖现有的AI模型配置和模板数据**
- 容器初始化脚本会检测并保护现有数据：
  - 如果 `backend/data/models/` 目录已有模型配置，不会覆盖
  - 如果 `backend/data/templates/` 目录已有模板，不会覆盖
  - 只有在目录为空时才会复制预设数据

### 📊 常用管理命令

```bash
# 查看服务状态
docker-compose ps

# 查看日志
docker-compose logs -f

# 停止服务
docker-compose down

# 重启服务
docker-compose restart

# 备份数据
tar -czf backup-$(date +%Y%m%d).tar.gz backend/
```

### 🔧 故障排除

**数据加载失败问题（重要）：**

如果遇到"模板或模型加载失败"的错误：

```bash
# 方法1：重启后端服务（通常能解决）
docker-compose restart backend

# 方法2：检查数据目录状态
docker exec word-xinghuidian-backend ls -la /app/data/

# 方法3：手动触发数据恢复
docker exec word-xinghuidian-backend sh -c "cp -r /app/preset-data/* /app/data/"
docker-compose restart backend

# 方法4：使用更新脚本的自动修复功能
./update.sh
```

**端口占用问题：**

```bash
# 检查端口占用
netstat -tulpn | grep :3000
netstat -tulpn | grep :3003

# 修改端口（编辑 docker-compose.yml）
```

**服务启动失败：**

```bash
# 查看详细日志
docker-compose logs backend
docker-compose logs frontend

# 检查健康状态
curl http://localhost:3003/api/health
```

**镜像拉取失败：**

```bash
# 手动拉取镜像
docker pull xieyifanxyf/word-xinghuidian-backend:latest
docker pull xieyifanxyf/word-xinghuidian-frontend:latest
```

### 📞 技术支持

如遇到问题，请提供以下信息：

- 系统版本：`uname -a`
- Docker版本：`docker --version`
- 服务状态：`docker-compose ps`
- 错误日志：`docker-compose logs`

---

**版本信息：**

- 镜像仓库：xieyifanxyf/word-xinghuidian-*
- 最新版本：v1.6.3
- 更新日期：2025-08-22
- 新增功能：
  - v1.6.3: 修复CORS配置，支持从环境变量读取
  - v1.6.2: 支持钉钉认证动态切换
