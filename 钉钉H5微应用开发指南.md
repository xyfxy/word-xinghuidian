# 钉钉H5微应用开发指南

> 基于2025年最新钉钉开放平台文档整理

## 概述

钉钉H5微应用开发实际上比我们想象的要简单得多。对于企业内部应用，主要就是将现有的Web应用嵌入到钉钉工作台中，实现免登和基本的钉钉功能集成。

## 开发流程（实际只需要4步）

### 1. 创建钉钉应用（5分钟）

1. 登录 [钉钉开放平台](https://open.dingtalk.com/)
2. 选择 "应用开发" → "企业内部开发" → "H5微应用" → "创建应用"
3. 填写基本信息：
   - 应用名称：Word星辉点编辑器
   - 应用描述：智能Word文档编辑器
   - 应用图标：上传应用图标
4. 获得关键信息：
   - AppKey
   - AppSecret
   - AgentId

### 2. 配置应用信息（10分钟）

在钉钉开发者后台配置：

```
应用首页地址：https://your-domain.com/
服务器出口IP：你的服务器IP地址
权限范围：选择需要的权限（通讯录基础信息、手机号等）
```

### 3. 前端集成钉钉SDK（30分钟）

#### 3.1 引入钉钉JSAPI

```html
<!-- 在index.html中引入 -->
<script src="https://g.alicdn.com/dingding/dingtalk-jsapi/2.7.0/dingtalk.open.js"></script>
```

#### 3.2 实现钉钉免登（核心代码）

```javascript
// 钉钉初始化和免登
import * as dd from 'dingtalk-jsapi';

class DingTalkAuth {
  constructor() {
    this.corpId = 'your-corp-id';
    this.agentId = 'your-agent-id';
  }

  // 初始化钉钉环境
  async init() {
    return new Promise((resolve, reject) => {
      dd.ready(() => {
        dd.runtime.permission.requestAuthCode({
          corpId: this.corpId,
          onSuccess: (result) => {
            // 获取到免登授权码
            this.getUserInfo(result.code).then(resolve).catch(reject);
          },
          onFail: (err) => {
            console.error('钉钉免登失败:', err);
            reject(err);
          }
        });
      });
    });
  }

  // 通过授权码获取用户信息
  async getUserInfo(code) {
    const response = await fetch('/api/dingtalk/getUserInfo', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ code })
    });
    return response.json();
  }
}

// 使用
const dingAuth = new DingTalkAuth();
dingAuth.init().then(userInfo => {
  console.log('用户信息:', userInfo);
  // 用户已登录，可以正常使用应用
}).catch(err => {
  console.error('钉钉登录失败:', err);
});
```

### 4. 后端接口开发（20分钟）

#### 4.1 获取AccessToken

```javascript
// Node.js 示例
const axios = require('axios');

class DingTalkService {
  constructor() {
    this.appKey = 'your-app-key';
    this.appSecret = 'your-app-secret';
    this.accessToken = null;
    this.tokenExpiry = 0;
  }

  // 获取AccessToken
  async getAccessToken() {
    if (this.accessToken && Date.now() < this.tokenExpiry) {
      return this.accessToken;
    }

    const url = `https://oapi.dingtalk.com/gettoken?appkey=${this.appKey}&appsecret=${this.appSecret}`;
    const response = await axios.get(url);
    
    if (response.data.errcode === 0) {
      this.accessToken = response.data.access_token;
      this.tokenExpiry = Date.now() + (response.data.expires_in - 300) * 1000; // 提前5分钟刷新
      return this.accessToken;
    }
    
    throw new Error('获取AccessToken失败');
  }

  // 通过授权码获取用户信息
  async getUserInfoByCode(code) {
    const accessToken = await this.getAccessToken();
    
    // 1. 通过code获取userid
    const userIdResponse = await axios.post(
      `https://oapi.dingtalk.com/topapi/v2/user/getuserinfo?access_token=${accessToken}`,
      { code }
    );
    
    if (userIdResponse.data.errcode !== 0) {
      throw new Error('获取用户ID失败');
    }
    
    const userId = userIdResponse.data.result.userid;
    
    // 2. 通过userid获取用户详细信息
    const userInfoResponse = await axios.post(
      `https://oapi.dingtalk.com/topapi/v2/user/get?access_token=${accessToken}`,
      { userid: userId }
    );
    
    if (userInfoResponse.data.errcode !== 0) {
      throw new Error('获取用户信息失败');
    }
    
    return userInfoResponse.data.result;
  }
}

// API接口
app.post('/api/dingtalk/getUserInfo', async (req, res) => {
  try {
    const { code } = req.body;
    const dingService = new DingTalkService();
    const userInfo = await dingService.getUserInfoByCode(code);
    res.json({ success: true, data: userInfo });
  } catch (error) {
    res.status(500).json({ success: false, error: error.message });
  }
});
```

## 安全控制（确保只能钉钉访问）

### 1. 前端检测

```javascript
// 检测是否在钉钉环境
function isDingTalkEnv() {
  return navigator.userAgent.includes('DingTalk') || 
         window.dd !== undefined;
}

// 页面初始化时检查
if (!isDingTalkEnv()) {
  alert('请在钉钉中打开此应用');
  document.body.innerHTML = '<div style="text-align:center;margin-top:100px;"><h2>请在钉钉中打开此应用</h2></div>';
}
```

### 2. 后端验证

```javascript
// 中间件：验证请求来源
const verifyDingTalkAccess = (req, res, next) => {
  const userAgent = req.headers['user-agent'];
  const referer = req.headers['referer'];
  
  // 检查User-Agent是否来自钉钉
  if (!userAgent || !userAgent.includes('DingTalk')) {
    return res.status(403).json({ error: '访问被拒绝：请通过钉钉访问' });
  }
  
  // 可选：检查Referer
  if (referer && !referer.includes('dingtalk.com')) {
    return res.status(403).json({ error: '访问被拒绝：非法来源' });
  }
  
  next();
};

// 应用到所有API路由
app.use('/api', verifyDingTalkAccess);
```

## 部署上线

### 1. 域名配置
- 确保你的域名已备案
- 在钉钉开发者后台配置可信域名
- 必须使用HTTPS

### 2. 发布流程
1. 在钉钉开发者后台点击"版本管理"
2. 添加测试人员进行内测
3. 测试通过后点击"发布"
4. 企业管理员在工作台添加应用

### 3. 工作台配置
- 企业管理员登录钉钉管理后台
- 进入"工作台" → "应用管理"
- 找到你的应用并添加到工作台
- 设置可见范围（部门/人员）

## 实际时间评估

基于上述简化流程，真实的开发时间：

| 阶段 | 时间 | 说明 |
|------|------|------|
| 应用创建配置 | 0.5天 | 钉钉后台操作 |
| 前端集成改造 | 1-2天 | 主要是免登集成 |
| 后端接口开发 | 0.5天 | 用户信息获取接口 |
| 测试调试 | 1天 | 功能测试和问题修复 |
| **总计** | **3-4天** | **远比想象的简单** |

## 总结

钉钉H5微应用开发实际上就是：
1. **包装现有应用**：将你的Web应用包装成钉钉应用
2. **实现免登**：用钉钉的用户体系替代原有登录
3. **安全控制**：确保只能在钉钉环境访问
4. **发布上线**：在钉钉工作台展示

**关键点**：不需要重写应用，只需要添加钉钉集成层！

## 参考资源

- [钉钉开放平台](https://open.dingtalk.com/)
- [H5微应用开发文档](https://open.dingtalk.com/document/orgapp/develop-org-h5-micro-applications)
- [JSAPI文档](https://open.dingtalk.com/document/orgapp-client/jsapi-overview)